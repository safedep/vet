name: Publish to MCP Registry

on: # Every new version release of `vet`
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC authentication
      contents: read

    steps:
      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Get version from tag
        run: echo "VET_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: fill version in server.json
        run: sed -i "s/VERSION_FROM_ENV/$VET_VERSION/g" server.json

      - name: Go to .mcp-publisher directory
        run: cd .mcp-publisher

      # publish mcp server
      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

      - name: Authenticate to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish server to MCP Registry
        run: ./mcp-publisher publish

  verify-publish:
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read

    steps:
      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get version from tag
        run: echo "VET_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Query MCP Registry and verify server is published
        env:
          SERVER_NAME: "io.github.safedep/vet-mcp"
          EXPECTED_VERSION: $VET_VERSION
          REGISTRY_URL: "https://registry.modelcontextprotocol.io/v0.1/servers"
        run: |
          echo "Checking MCP Registry for $SERVER_NAME"

          # Query registry
          url="${REGISTRY_URL}?search=${SERVER_NAME}"
          echo "Requesting: $url"
          http_status=$(curl -s -o response.json -w "%{http_code}" "$url")
          if [ "$http_status" -ne 200 ]; then
            echo "Registry query failed with HTTP status $http_status"
            cat response.json || true
            exit 1
          fi

          # Pretty print the response for debugging
          echo "Registry response (truncated):"
          jq 'if .servers then {servers: (.servers | length)} else . end' response.json

          # Verify server name exists in servers array
          if [ -z "$EXPECTED_VERSION" ]; then
            # Only check for presence by name
            jq -e --arg name "$SERVER_NAME" '.servers[]? | select(.name == $name)' response.json >/dev/null || {
              echo "ERROR: Server $SERVER_NAME not found in registry response"
              echo "Full response:"
              cat response.json
              exit 1
            }
            echo "Found server $SERVER_NAME"
          else
            # Check for both name and version match
            jq -e --arg name "$SERVER_NAME" --arg ver "$EXPECTED_VERSION" '.servers[]? | select(.name == $name and (.version == $ver or (.packages[]? | select(.version==$ver) // empty)))' response.json >/dev/null || {
              echo "ERROR: Server $SERVER_NAME with version $EXPECTED_VERSION not found"
              echo "Full response:"
              cat response.json
              exit 1
            }
            echo "Found server $SERVER_NAME with version $EXPECTED_VERSION"
          fi
